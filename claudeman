#!/bin/bash

# claudeman - Run Claude Code in a container with custom dependencies

set -e
trap 'echo "Error at line $LINENO"; exit 1' ERR

# Discover lib directory (Homebrew-aware, resolves symlinks)
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [ -L "$SCRIPT_PATH" ]; do
    SCRIPT_DIR="$(cd -P "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    [[ $SCRIPT_PATH != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SCRIPT_PATH")" && pwd)"

LIB_DIR="${SCRIPT_DIR}/../share/claudeman/lib"  # Homebrew location
[ ! -d "$LIB_DIR" ] && LIB_DIR="${SCRIPT_DIR}/lib"  # Development/local install

# Set path to the devcontainer directory
CONTAINER_RAW_DIR="https://raw.githubusercontent.com/anthropics/claude-code/refs/heads/main/.devcontainer"

# Ensure local claude directories exist
function ensure_claude_dir {
    echo "Creating claude directories..."
    mkdir -p .claude
    touch .claude/.bash_history
}

function build_container() {
    echo "Using timezone: $TIMEZONE"
    TEMP_DIR=$(mktemp -d)
    curl -s $CONTAINER_RAW_DIR/Dockerfile -o $TEMP_DIR/Dockerfile
    curl -s $CONTAINER_RAW_DIR/init-firewall.sh -o $TEMP_DIR/init-firewall.sh
    podman build -t claude-code --build-arg TZ="$TIMEZONE" $TEMP_DIR
}

# Function to run container with common options
function run_container {
    local cmd=${1:-""}  # Command to run (optional)

    # Common environment variables
    # Get the current Terminal window ID where claude-code is running interactively, and assign to a shell variable
    local winid=$(osascript -e 'tell application "Terminal" to id of front window')
    local env_vars=(
        "-e NODE_OPTIONS=--max-old-space-size=4096"
        "-e CLAUDE_CONFIG_DIR=/home/node/.claude"
        "-e POWERLEVEL9K_DISABLE_GITSTATUS=true"
        "-e WINID=$winid"
    )
    if [[ -n ${RUNTIME_PATH:-} ]]; then
        env_vars+=(
            "-e PATH=$RUNTIME_PATH"
        )
    fi

    # Common volume mounts
    local volumes=(
        "-v $(pwd)/.claude:/home/node/.claude"
        "-v $(pwd)/.claude/.bash_history:/commandhistory/.bash_history"
        "-v $(pwd):/workspace"
    )

    # Common local args
    local args=(
        "--cap-add=NET_ADMIN"
        "--cap-add=NET_RAW"
    )

    # Build the command
    podman run --rm -it ${env_vars[@]} ${volumes[@]} ${args[@]} claude-code ${cmd}
}

function usage {
    echo "Usage: claudeman [run|listen|help] [options]"
    echo ""
    echo "Run from within a project directory"
    echo ""
    echo "Commands:"
    echo "  run [--] [cmd]   Run an interactive container (default cmd: claude --dangerously-skip-permissions)"
    echo "  listen [port]    Start the notification listener (default port: 8080)"
    echo "  help             Displays help"
    echo ""
    echo "Options:"
    echo "  --   Separator between options and command"
    echo ""
    echo "Examples:"
    echo "  - Default: \`claudeman run\`"
    echo "  - Custom command: \`claudeman run -- claude\`"
    echo "  - Bash shell: \`claudeman run -- bash\`"
    echo "  - Start listener: \`claudeman listen\`"
    echo "  - Listener on custom port: \`claudeman listen 8085\`"
    echo ""
    echo "Automatic Notifications:"
    echo "  Claudeman uses Claude Code's hook system to automatically notify you:"
    echo "  - Questions: Notified when Claude asks a question (automatic)"
    echo "  - Task Progress: Notified after active tools complete (automatic)"
    echo "  - Structured Questions: Claude forced to use AskUserQuestion (automatic)"
    echo ""
    echo "Manual Notifications (if needed):"
    echo "  - Complete: \`node /home/node/.claude/claudeman/notify.js -t complete -m \"message\"\`"
    echo "  - Question: \`node /home/node/.claude/claudeman/notify.js -t question -m \"message\"\`"
    echo "  - Info: \`node /home/node/.claude/claudeman/notify.js -t info -m \"message\"\`"
    echo ""
}

# Get current timezone in IANA format (e.g. "America/New_York")
TIMEZONE=$(readlink /etc/localtime | sed 's/.*zoneinfo\///')

# Check if no arguments are provided
if [ -z "${1:-}" ]; then
  usage
  exit 0
fi

command=$1
shift

case $command in
    run)
        echo "Running interactive container..."
        ensure_claude_dir

        # Create claudeman directory structure
        mkdir -p .claude/claudeman

        # Merge hooks into settings.json
        if [ -f "$LIB_DIR/hooks.json" ]; then
            echo "Merging hooks into settings.json"
            node "$LIB_DIR/merge-hooks.js" .claude/settings.json "$LIB_DIR/hooks.json"
        fi

        # Always copy claudeman files (get updates)
        if [ -f "$LIB_DIR/dependencies.sh" ]; then
            echo "Updating dependencies.sh from $LIB_DIR"
            cp "$LIB_DIR/dependencies.sh" .claude/claudeman/dependencies.sh
            chmod +x .claude/claudeman/dependencies.sh
        fi

        if [ -f "$LIB_DIR/notify.js" ]; then
            echo "Updating notify.js from $LIB_DIR"
            cp "$LIB_DIR/notify.js" .claude/claudeman/notify.js
        fi

        if [ -f "$LIB_DIR/check-completion.js" ]; then
            echo "Updating check-completion.js from $LIB_DIR"
            cp "$LIB_DIR/check-completion.js" .claude/claudeman/check-completion.js
            chmod +x .claude/claudeman/check-completion.js
        fi

        if [ -f "$LIB_DIR/dedup.js" ]; then
            echo "Updating dedup.js from $LIB_DIR"
            cp "$LIB_DIR/dedup.js" .claude/claudeman/dedup.js
            chmod +x .claude/claudeman/dedup.js
        fi

        if [ -f "$LIB_DIR/enforce-questions.sh" ]; then
            echo "Updating enforce-questions.sh from $LIB_DIR"
            cp "$LIB_DIR/enforce-questions.sh" .claude/claudeman/enforce-questions.sh
            chmod +x .claude/claudeman/enforce-questions.sh
        fi

        build_container

        # Check if deps need to be installed
        if [ ! -d .claude/claudeman/deps/go ]; then
            # Check if API key is configured (in ~/.claude/.claude.json)
            HAS_API_KEY=false
            if [ -f ~/.claude/.claude.json ]; then
                # Check for primaryApiKey or oauthAccount
                if jq -e '.primaryApiKey // .oauthAccount' ~/.claude/.claude.json > /dev/null 2>&1; then
                    HAS_API_KEY=true
                fi
            fi

            WAIT_MESSAGE="First run: Installing Go and development tools.\nThis may take a few minutes.\nYou'll see the Claude prompt when ready."

            if [ "$HAS_API_KEY" = false ]; then
                # First time setup - user won't see stdout during API key prompt
                # Show both macOS notification and stdout
                echo ""
                echo "=========================================="
                echo -e "$WAIT_MESSAGE"
                echo "=========================================="
                echo ""

                # Notify via listener if running (using notify.js from host)
                if node "$LIB_DIR/notify.js" -h localhost -t info -m "$WAIT_MESSAGE" 2>/dev/null; then
                    echo "Notification sent via listener"
                fi
            else
                # API key exists - user will see stdout, so no notification needed
                echo ""
                echo "=========================================="
                echo -e "$WAIT_MESSAGE"
                echo "=========================================="
                echo ""
            fi
        fi

        # Build runtime PATH with Go tools
        BUILDTIME_PATH=$(podman inspect localhost/claude-code | jq -r '.[0].Config.Env[] | select(startswith("PATH="))' | sed 's/^PATH=//')
        RUNTIME_PATH="/workspace/.claude/claudeman/deps/go/bin:/workspace/.claude/claudeman/deps/gopath/bin:$BUILDTIME_PATH"

        # Parse flags
        while [[ $# -gt 0 ]]; do
            case $1 in
                --)
                    shift
                    break
                    ;;
                *)
                    break
                    ;;
            esac
        done

        [ $# -eq 0 ] && CMD="claude --dangerously-skip-permissions" || CMD="$@"
        run_container "$CMD"
        ;;
    listen)
        PORT="${1:-8080}"
        if [ ! -f "$LIB_DIR/listener.js" ]; then
            echo "Error: listener.js not found at $LIB_DIR/listener.js"
            exit 1
        fi
        echo "Starting notification listener on port $PORT..."
        echo "Press Ctrl+C to stop"
        if [ "$PORT" = "8080" ]; then
            node "$LIB_DIR/listener.js"
        else
            node "$LIB_DIR/listener.js" -p "$PORT"
        fi
        ;;
    help)
        usage
        ;;
    *)
        echo "Error: Unknown command '$command'"
        usage
        exit 1
        ;;
esac
